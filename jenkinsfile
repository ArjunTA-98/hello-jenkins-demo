pipeline {
  agent any
  stages {
    stage('Checkout') { 
      steps { 
        checkout scm 
      } 
    }
    
    stage('Install & Build') {
      steps {
        sh 'echo Installing dependencies, including PM2...'
        // This 'npm install' now installs PM2 locally and safely
        sh 'npm install'
      }
    }
    
    stage('Deploy & Verify') {
      steps {
        sh 'echo Deploying application persistently...'
        // Use the locally installed PM2 via ./node_modules/.bin/pm2
        sh './node_modules/.bin/pm2 delete hello-node || true' 
        sh './node_modules/.bin/pm2 start server.js --name hello-node' 
        
        sh 'sleep 5'
        
        // Verify the app is running persistently on port 3000
        sh 'curl -f http://localhost:3000/health || echo Health check failed' 
      }
    }
  }
  post {
    success { 
      echo '✅ Deployment successful. App is running persistently on port 3000.' 
    }
    failure { 
      echo '❌ Deployment failed. Check the Build log for errors.' 
    }
  }
}
